<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rice Bowl Monster - Masuk</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#4C2A85;--card:#fff;--text:#374151;--muted:#6b7280;--primary:#4C2A85;--primary-text:#fff;--border:#e5e7eb;--ring:rgba(76, 42, 133, 0.4);--success:#16a34a;--error:#dc2626}*{-webkit-box-sizing:border-box;box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}.auth-body{display:grid;place-items:center;padding:24px}.auth-container{width:100%;max-width:420px;background:var(--card);border-radius:24px;padding:28px;-webkit-box-shadow:0 10px 30px rgba(0,0,0,.2);box-shadow:0 10px 30px rgba(0,0,0,.2)}.brand{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;margin-bottom:24px}.logo{width:65px;height:65px;-ms-flex-negative:0;flex-shrink:0}.logo img{width:100%;height:100%;-o-object-fit:contain;object-fit:contain}.brand-text h1{font-size:20px;margin:0 0 4px 0;color:var(--text);white-space:nowrap}.brand-text p{margin:0;font-size:14px;color:var(--muted);white-space:nowrap}.auth-form{display:grid;gap:16px}.form-field{display:grid;gap:8px}.form-field label{font-size:14px;font-weight:500;color:var(--muted)}.form-field input{border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-size:16px;background-color:var(--card);width:100%;outline:0}.form-field input:focus{border-color:var(--primary);-webkit-box-shadow:0 0 0 4px var(--ring);box-shadow:0 0 0 4px var(--ring)}.input-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:1px solid var(--border);border-radius:10px;-webkit-transition:all .2s;transition:all .2s}.input-group:focus-within{border-color:var(--primary);-webkit-box-shadow:0 0 0 4px var(--ring);box-shadow:0 0 0 4px var(--ring)}.input-prefix{padding:12px 10px 12px 14px;font-size:16px;color:var(--text);background-color:#f9fafb;border-right:1px solid var(--border)}.input-group input{border:none;-webkit-box-shadow:none;box-shadow:none;background:0 0}.message{font-size:14px;min-height:20px;text-align:center}.message.success{color:var(--success)}.message.error{color:var(--error)}.auth-actions{display:-webkit-box;display:-ms-flexbox;display:flex;gap:10px;margin-top:4px}.btn{width:100%;padding:12px 24px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-size:16px;font-weight:700;-webkit-transition:all .2s;transition:all .2s}.btn:disabled{cursor:not-allowed;opacity:.7}.btn-primary{background:var(--primary);color:var(--primary-text)}.btn-primary:hover:not(:disabled){background:#3c216b}.btn-outline{background:var(--card);color:var(--primary);border-color:var(--border)}.btn-outline:hover:not(:disabled){background:#f9fafb;border-color:#d1d5db}.auth-footer{text-align:center;margin-top:20px}.modal{border:none;border-radius:12px;padding:0;max-width:400px;-webkit-box-shadow:0 10px 30px rgba(0,0,0,.2);box-shadow:0 10px 30px rgba(0,0,0,.2)}.modal::-webkit-backdrop{background:rgba(0,0,0,.5)}.modal::backdrop{background:rgba(0,0,0,.5)}.modal-card{padding:32px;display:grid;gap:18px}.modal-card h2{margin:0 0 8px 0;text-align:center}.modal-actions{display:-webkit-box;display:-ms-flexbox;display:flex;gap:10px}
  </style>
</head>

<body class="auth-body">

  <main class="auth-container">
    <div class="brand">
      <div class="logo">
        <img src="logo-rbm.png" alt="Rice Bowl Monster Logo">
      </div>
      <div class="brand-text">
        <h1>Rice Bowl Monsters</h1>
        <p>Hallo, Monsters Lovers</p>
      </div>
    </div>

    <form class="auth-form" id="login-form">
      <div class="form-field">
        <label for="username">No. Telepon (Username)</label>
        <div class="input-group">
          <span class="input-prefix">+62</span>
          <input type="tel" id="username" name="username" placeholder="81234567890" required>
        </div>
      </div>

      <div id="login-message" class="message"></div>
      <div class="auth-actions">
        <button type="button" class="btn btn-outline" id="btn-daftar">Daftar</button>
        <button type="submit" class="btn btn-primary">Login</button>
      </div>
      <a href="home.html" class="btn btn-outline" style="text-align: center; text-decoration: none; margin-top: 8px;">Kembali ke Beranda</a>
    </form>

    <footer class="auth-footer">
      <small>Â© <span id="year"></span> Rice Bowl Monster</small>
    </footer>
  </main>

  <dialog id="daftar-modal" class="modal">
    <form class="modal-card" id="register-form">
      <h2>Buat Akun Baru</h2>
      <div class="form-field">
        <label for="reg-nama">Nama Lengkap</label>
        <input type="text" id="reg-nama" name="reg-nama" placeholder="Masukkan nama lengkap" required>
      </div>
      <div class="form-field">
        <label for="reg-username">No. Telepon (Username)</label>
        <div class="input-group">
          <span class="input-prefix">+62</span>
          <input type="tel" id="reg-username" name="reg-username" placeholder="81234567890" required>
        </div>
      </div>
      <div id="register-message" class="message"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="btn-batal">Batal</button>
        <button type="submit" class="btn btn-primary">Daftar</button>
      </div>
    </form>
  </dialog>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5xRkvhJSsgGvq6tYeKc4VBwzTyw6bpZgexRYtIYCTgXiGtN1wahPhSijnH5h3VHez/exec';
    
    const yearSpan = document.getElementById('year');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const loginMessage = document.getElementById('login-message');
    const daftarBtn = document.getElementById('btn-daftar');
    const daftarModal = document.getElementById('daftar-modal');
    const registerForm = document.getElementById('register-form');
    const regNamaInput = document.getElementById('reg-nama');
    const regUsernameInput = document.getElementById('reg-username');
    const registerMessage = document.getElementById('register-message');
    const batalBtn = document.getElementById('btn-batal');

    yearSpan.textContent = new Date().getFullYear();

    function showMessage(element, text, isError = false) {
      element.textContent = text;
      element.className = isError ? 'message error' : 'message success';
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const loginButton = e.submitter;
      const phoneNumber = usernameInput.value;

      loginButton.disabled = true;
      loginButton.textContent = 'Memproses...';
      showMessage(loginMessage, '');

      fetch(`${SCRIPT_URL}?phone=${phoneNumber}`)
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            const userProfile = {
              nama: result.data.nama,
              phone: result.data.phone,
              username: result.data.username,
              points: result.data.points_sisa
            };
            localStorage.setItem('rbm_user', JSON.stringify(userProfile));
            
            showMessage(loginMessage, 'Login berhasil!', false);
            setTimeout(() => {
              window.location.href = 'home.html';
            }, 1000);
          } else {
            showMessage(loginMessage, result.message, true);
          }
        })
        .catch(error => {
          showMessage(loginMessage, 'Koneksi gagal. Periksa kembali jaringan Anda.', true);
          console.error('Error:', error);
        })
        .finally(() => {
          loginButton.disabled = false;
          loginButton.textContent = 'Login';
        });
    });

    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const registerButton = e.submitter;
      registerButton.disabled = true;
      registerButton.textContent = 'Mendaftar...';
      showMessage(registerMessage, '');

      const payload = {
        action: 'register',
        nama: regNamaInput.value,
        username: regUsernameInput.value
      };

      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8',
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(result => {
        if (result.status === 'success') {
          showMessage(registerMessage, result.message, false);
          setTimeout(() => {
            daftarModal.close();
            usernameInput.value = regUsernameInput.value;
            loginForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true, submitter: loginForm.querySelector('button[type="submit"]') }));
          }, 2000);
        } else {
          showMessage(registerMessage, result.message, true);
        }
      })
      .catch(error => {
        showMessage(registerMessage, 'Koneksi gagal. Coba lagi.', true);
        console.error('Error:', error);
      })
      .finally(() => {
        registerButton.disabled = false;
        registerButton.textContent = 'Daftar';
      });
    });

    daftarBtn.addEventListener('click', () => {
      if (typeof daftarModal.showModal === 'function') {
        registerForm.reset();
        showMessage(registerMessage, '');
        daftarModal.showModal();
      } else {
        alert('Dialog tidak didukung pada browser ini.');
      }
    });

    batalBtn.addEventListener('click', () => {
      daftarModal.close();
    });
  </script>
</body>
</html>